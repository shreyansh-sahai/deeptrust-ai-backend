// Registry of supported integrations (global configuration)
model Integration {
  id              String   @id @default(uuid())
  slug            String   @unique // e.g., 'google-people', 'google-calendar', 'google-gmail'
  name            String   // e.g., 'Google Contacts'
  provider        String   // 'google', 'microsoft', 'apple'
  isGlobalEnabled Boolean  @default(true)
  authBaseUrl     String?
  tokenUrl        String?
  requiredScopes  String[] // Array of scopes needed
  createdAt       DateTime @default(now())

  integrationAccounts IntegrationAccount[]

  @@map("integrations")
}

// Links a User to an Integration - holds encrypted credentials
model IntegrationAccount {
  id                String   @id @default(uuid())
  userId            String
  integrationId     String
  // Identity Data (The "Who")
  remoteProviderId  String   // Google's 'sub' or immutable user ID
  remoteEmail       String?  // The email of the connected account
  // Security Credentials (The "Keys") - stored as encrypted strings
  accessTokenEnc    String   // Encrypted access token (AES-256-GCM)
  refreshTokenEnc   String   // Encrypted refresh token
  // Lifecycle Management
  tokenExpiresAt    DateTime
  scopesGranted     String[] // The actual scopes granted by the user
  // Connection Health
  status            String   @default("active") // 'active', 'disconnected', 'expired_token', 'needs_reauth'
  lastErrorMessage  String?
  disconnectReason  String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  integration Integration  @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  syncStates  SyncState[]
  syncLogs   SyncLog[]
  integrationAccountContacts IntegrationAccountContact[]
  emails     Email[]
  calendarEvents CalendarEvent[]

  @@unique([userId, integrationId, remoteProviderId])
  @@index([status])
  @@map("integration_accounts")
}

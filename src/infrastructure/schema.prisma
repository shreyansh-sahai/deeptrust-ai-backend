// ============================================
// base.prisma
// ============================================

datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
}



// ============================================
// user.prisma
// ============================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  fullName  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  isActive  Boolean  @default(true)
  contactId String?
  metadata  Json @default("{}")

  integrationAccounts IntegrationAccount[]
  userContacts        UserContact[]
  networkUserIntents  NetworkUserIntent[]
  profile             UserProfile?
  dtInvisibilityProcesses DTInvisibilityProcesses?
  identities        UserIdentity[]

  @@map("users")
}


// ============================================
// user_profile.prisma
// ============================================

model UserProfile {
  userId               String   @id
  professionalHeadline String?
  professionalBio      String?
  currentOrganization  String?
  state               String?
  city                String?
  country             String?
  timezone            String?
  videoIntroductionURL String?
  mobileNumber        String?
  linkedinUrl         String?
  professionalExperience Json?   @default("[]")
  updatedAt           DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}


// ============================================
// user_identity.prisma
// ============================================

model UserIdentity {
  id          String   @id @default(uuid())
  userId      String
  identity    Json     @default("{}")
  embedding   Unsupported("vector(1536)")?
  created_at  DateTime @default(now())
  updated_at  DateTime?
  isDeleted   Boolean  @default(false)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isDeleted])
  @@map("user_identities")
}

// ============================================
// integration.prisma
// ============================================

// Registry of supported integrations (global configuration)
model Integration {
  id              String   @id @default(uuid())
  slug            String   @unique // e.g., 'google-people', 'google-calendar', 'google-gmail'
  name            String   // e.g., 'Google Contacts'
  provider        String   // 'google', 'microsoft', 'apple'
  isGlobalEnabled Boolean  @default(true)
  authBaseUrl     String?
  tokenUrl        String?
  requiredScopes  String[] // Array of scopes needed
  createdAt       DateTime @default(now())

  integrationAccounts IntegrationAccount[]

  @@map("integrations")
}

// Links a User to an Integration - holds encrypted credentials
model IntegrationAccount {
  id                String   @id @default(uuid())
  userId            String
  integrationId     String
  // Identity Data (The "Who")
  remoteProviderId  String   // Google's 'sub' or immutable user ID
  remoteEmail       String?  // The email of the connected account
  // Security Credentials (The "Keys") - stored as encrypted strings
  accessTokenEnc    String   // Encrypted access token (AES-256-GCM)
  refreshTokenEnc   String   // Encrypted refresh token
  // Lifecycle Management
  tokenExpiresAt    DateTime
  scopesGranted     String[] // The actual scopes granted by the user
  // Connection Health
  status            String   @default("active") // 'active', 'disconnected', 'expired_token', 'needs_reauth'
  lastErrorMessage  String?
  disconnectReason  String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  integration Integration  @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  syncStates  SyncState[]
  syncLogs   SyncLog[]
  integrationAccountContacts IntegrationAccountContact[]
  emails     Email[]
  calendarEvents CalendarEvent[]

  @@unique([userId, integrationId, remoteProviderId])
  @@index([status])
  @@map("integration_accounts")
}


// ============================================
// sync.prisma
// ============================================

// Tracks synchronization progress (the "Anchor State")
model SyncState {
  id                  String   @id @default(uuid())
  integrationAccountId String
  // Resource Partitioning
  resourceType        String   // 'contacts', 'calendar_events', 'gmail_messages'
  resourceId          String   @default("default") // 'people/me' or a specific Calendar ID
  // The Anchors (Polymorphic Token Storage)
  syncToken           String?  // Google People & Calendar use 'sync_token'
  historyId           String?  // Gmail uses 'history_id' (integer-like string)
  // Transient Pagination State (Crash Recovery)
  currentPageToken    String?  // Stores the 'nextPageToken' if job is mid-flight
  // Sync Metadata
  lastSyncedAt        DateTime?
  lastSuccessAt       DateTime?
  lastAttemptStatus   String   @default("pending") // 'success', 'failed', 'partial'
  // Logical Flags
  fullSyncRequired    Boolean  @default(false) // Force a full re-sync (e.g., after 410 error)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  integrationAccount IntegrationAccount @relation(fields: [integrationAccountId], references: [id], onDelete: Cascade)

  syncLogs SyncLog[]

  @@unique([integrationAccountId, resourceType, resourceId])
  @@index([integrationAccountId])
  @@index([resourceType])
  @@map("sync_states")
}

// Operational logging for sync processes
model SyncLog {
  id                  String   @id @default(uuid())
  integrationAccountId String?
  syncStateId        String?
  // Execution Timing
  startTime          DateTime  @default(now())
  endTime            DateTime?
  durationMs         Int?
  // Outcome
  status             String    // 'running', 'completed', 'failed', 'cancelled'
  triggerSource      String?   // 'cron', 'webhook', 'manual'
  // Metrics (Data Volume)
  itemsFetched       Int       @default(0)
  itemsUpserted      Int       @default(0)
  itemsDeleted       Int       @default(0)
  // Diagnostics
  errorCode          String?   // e.g., '410', '401', 'RATE_LIMIT_EXCEEDED'
  errorMessage       String?
  stackTrace         String?
  // Context
  meta               Json      @default("{}")

  integrationAccount IntegrationAccount? @relation(fields: [integrationAccountId], references: [id], onDelete: SetNull)
  syncState          SyncState?          @relation(fields: [syncStateId], references: [id], onDelete: SetNull)

  @@index([syncStateId, startTime(sort: Desc)])
  @@index([integrationAccountId])
  @@map("sync_logs")
}



// ============================================
// contact.prisma
// ============================================

// Sync table: All contacts from integration accounts (can have duplicates)
model IntegrationAccountContact {
  id                String   @id @default(uuid())
  integrationAccountId String
  googleResourceName String?  @unique // e.g., 'people/c12345'
  firstName         String?
  lastName          String?
  displayName       String?
  email             String?
  phoneNumber       String?
  organization      String?
  jobTitle          String?
  notes             String?
  photoUrl          String?
  isDeleted         Boolean   @default(false) // Soft delete
  syncedAt          DateTime  @default(now())
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  integrationAccount IntegrationAccount @relation(fields: [integrationAccountId], references: [id], onDelete: Cascade)

  @@index([integrationAccountId])
  @@index([googleResourceName])
  @@index([email])
  @@index([isDeleted])
  @@map("integration_accounts_contacts")
}

// Unique contacts table: Deduplicated contacts, unique by email
model Contact {
  id                String   @id @default(uuid())
  email             String?   @unique // Unique constraint on email
  firstName         String?
  lastName          String?
  displayName       String?
  phoneNumber       String?
  organization      String?
  jobTitle          String?
  notes             String?
  photoUrl          String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  userContacts      UserContact[]

  @@index([email])
  @@map("contacts")
}

// Many-to-many relationship between User and Contact
model UserContact {
  id                String   @id @default(uuid())
  userId            String
  contactId         String
  metadata          Json?    // JSONB in PostgreSQL
  buckets           String[] // Array of bucket names
  featureTags       String[] // Array of feature tags
  recencyScore      Float     @default(0)
  consistencyScore  Float     @default(0)
  symmetryRatio     Float     @default(1.0)
  lastInteractionAt DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  contact           Contact   @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([userId, contactId])
  @@index([userId])
  @@index([contactId])
  @@map("user_contacts")
}


// ============================================
// email.prisma
// ============================================

model Email {
  id                String   @id @default(uuid())
  integrationAccountId String
  gmailMessageId   String   @unique // Gmail message ID (e.g., '18c5f1a2b3c4d5e6')
  threadId         String   // Gmail thread ID
  // Message Headers
  subject          String?
  fromEmail        String?  // From email address
  fromName         String?  // From display name
  toEmails         String[] // Array of 'to' email addresses
  ccEmails         String[] // Array of 'cc' email addresses
  bccEmails        String[] // Array of 'bcc' email addresses
  replyTo          String?  // Reply-To header
  // Message Content
  snippet          String?  // Preview text (first ~100 chars)
  bodyText         String?  // Plain text body
  bodyHtml         String?  // HTML body (can be large)
  // Metadata
  labels           String[] // Gmail labels (INBOX, SENT, etc.)
  internalDate     DateTime? // Gmail internal date (when message was received)
  receivedDate     DateTime? // Parsed received date from headers
  sizeEstimate     Int?     // Message size in bytes
  // Sync & Lifecycle
  isDeleted        Boolean  @default(false) // Soft delete
  syncedAt         DateTime @default(now())
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  integrationAccount IntegrationAccount @relation(fields: [integrationAccountId], references: [id], onDelete: Cascade)

  @@index([integrationAccountId])
  @@index([gmailMessageId])
  @@index([threadId])
  @@index([isDeleted])
  @@index([internalDate])
  @@map("emails")
}


// ============================================
// calendar.prisma
// ============================================

model CalendarEvent {
  id                String   @id @default(uuid())
  integrationAccountId String
  googleEventId     String   // Google Calendar event ID
  calendarId        String   // Calendar ID (e.g., 'primary', or specific calendar ID)
  // Event Identity
  iCalUID           String?  // iCal UID (for cross-calendar deduplication)
  recurringEventId  String?  // For recurring events, links to master event
  // Event Details
  summary           String?  // Event title
  description       String?  // Event description
  location          String?  // Event location
  // Timing
  startDateTime     DateTime? // Start time (for date-time events)
  startDate         String?   // Start date (for all-day events, ISO format: YYYY-MM-DD)
  endDateTime       DateTime? // End time (for date-time events)
  endDate           String?   // End date (for all-day events, ISO format: YYYY-MM-DD)
  isAllDay          Boolean  @default(false) // Whether event is all-day
  timeZone          String?  // Timezone (e.g., 'America/New_York')
  // Attendees
  organizerEmail    String?  // Organizer email
  organizerName     String?  // Organizer display name
  attendeeEmails    String[] // Array of attendee email addresses
  attendeeNames     String[] // Array of attendee display names (parallel to emails)
  // Status & Visibility
  status            String?  // 'confirmed', 'tentative', 'cancelled'
  visibility        String?  // 'default', 'public', 'private', 'confidential'
  // Recurrence
  recurrence        String[] // RRULE strings (e.g., ['RRULE:FREQ=WEEKLY;BYDAY=MO'])
  // Metadata
  htmlLink          String?  // Link to open event in Google Calendar
  hangoutLink       String?  // Google Meet/Hangout link
  colorId           String?  // Calendar color ID
  // Sync & Lifecycle
  isDeleted         Boolean  @default(false) // Soft delete
  syncedAt          DateTime @default(now())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  integrationAccount IntegrationAccount @relation(fields: [integrationAccountId], references: [id], onDelete: Cascade)

  @@unique([integrationAccountId, calendarId, googleEventId])
  @@index([integrationAccountId])
  @@index([calendarId])
  @@index([googleEventId])
  @@index([iCalUID])
  @@index([isDeleted])
  @@index([startDateTime])
  @@index([startDate])
  @@map("calendar_events")
}


// ============================================
// network_user_intent.prisma
// ============================================

model NetworkUserIntent {
  id                 String    @id @default(uuid())
  userId             String
  intent             String
  intent_description String
  metadata           Json      @default("{}")
  voice_file_link    String?
  embedding          Unsupported("vector(1536)")?
  created_at         DateTime  @default(now())
  updated_at         DateTime?
  isDeleted          Boolean   @default(false)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isDeleted])
  @@map("network_user_intents")
}


// ============================================
// invisibility.prisma
// ============================================

// ============================================
// invisibility.prisma
// ============================================

model DTInvisibilityProcesses {
  id              String   @id @default(uuid())
  userId          String   @unique
  lastProcessedAt DateTime?
  status          String   @default("IDLE") // 'IDLE', 'RUNNING'
  lockedAt        DateTime?
  updatedAt       DateTime @updatedAt
  user            User     @relation(fields: [userId], references: [id])
  logs            DTInvisibilityProcessLog[]

  @@map("dt_invisibility_processes")
}

model DTInvisibilityProcessLog {
  id                      String   @id @default(uuid())
  dtInvisibilityProcessId String
  status                  String   // 'SUCCESS', 'FAILED'
  metrics                 Json     @default("{}") // {emails: 50, events: 10}
  error                   String?
  createdAt               DateTime @default(now())

  dtInvisibilityProcess   DTInvisibilityProcesses @relation(fields: [dtInvisibilityProcessId], references: [id])
  @@map("dt_invisibility_process_logs")
}


